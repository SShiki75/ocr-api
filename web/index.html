<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¬ã‚·ãƒ¼ãƒˆOCR - ç›´æ¥APIç‰ˆ</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ§¾ ãƒ•ã‚¡ãƒŸãƒªãƒ¼ãƒãƒ¼ãƒˆ ãƒ¬ã‚·ãƒ¼ãƒˆOCRï¼ˆç›´æ¥APIç‰ˆï¼‰</h1>
            <p>ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ç›´æ¥APIã«æ¥ç¶šï¼ˆinfinityfreeåˆ¶é™ã‚’å›é¿ï¼‰</p>
        </header>

        <section class="upload-section">
            <form id="uploadForm">
                <div class="file-input-wrapper">
                    <label for="receipt_image" class="file-label">
                        ğŸ“· ãƒ¬ã‚·ãƒ¼ãƒˆç”»åƒã‚’é¸æŠ
                    </label>
                    <input 
                        type="file" 
                        name="receipt_image" 
                        id="receipt_image" 
                        accept="image/*"
                        required
                    >
                    <span id="fileName" class="file-name">ãƒ•ã‚¡ã‚¤ãƒ«æœªé¸æŠ</span>
                </div>
                <button type="submit" class="btn btn-primary">ğŸ” OCRå®Ÿè¡Œ</button>
            </form>
        </section>

        <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
        <div id="loadingDiv" style="display: none;">
            <div class="alert alert-info">
                <div style="text-align: center; padding: 20px;">
                    <div class="spinner"></div>
                    <p style="margin-top: 15px; font-weight: bold;">ğŸ”„ OCRå‡¦ç†ä¸­...</p>
                    <p style="font-size: 0.9em; color: #666;">
                        â€» åˆå›èµ·å‹•æ™‚ã¯æœ€å¤§1åˆ†ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™<br>
                        ãã®ã¾ã¾ãŠå¾…ã¡ãã ã•ã„
                    </p>
                </div>
            </div>
        </div>

        <!-- ã‚¨ãƒ©ãƒ¼è¡¨ç¤º -->
        <div id="errorDiv" style="display: none;"></div>

        <!-- OCRçµæœè¡¨ç¤º -->
        <div id="resultSection" style="display: none;"></div>

        <footer>
            <p>Powered by Tesseract OCR + FastAPI</p>
            <p style="font-size: 0.9em; margin-top: 5px;">
                ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ç›´æ¥ <code>ocr-api-0sv3.onrender.com</code> ã«æ¥ç¶š
            </p>
            <div style="margin-top: 15px;">
                <a href="https://ocr-api-0sv3.onrender.com/logs/ocr/download" 
                   download="ocr.log" 
                   class="btn btn-secondary"
                   style="display: inline-block; text-decoration: none;">
                    ğŸ’¾ OCRãƒ­ã‚°ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                </a>
            </div>
        </footer>
    </div>

    <script>
        const API_URL = 'https://ocr-api-0sv3.onrender.com';

        // ãƒ•ã‚¡ã‚¤ãƒ«åè¡¨ç¤º
        document.getElementById('receipt_image').addEventListener('change', function(e) {
            const fileName = e.target.files[0]?.name || 'ãƒ•ã‚¡ã‚¤ãƒ«æœªé¸æŠ';
            document.getElementById('fileName').textContent = fileName;
        });

        // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const fileInput = document.getElementById('receipt_image');
            const file = fileInput.files[0];

            if (!file) {
                alert('ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            // UIæ›´æ–°
            document.getElementById('loadingDiv').style.display = 'block';
            document.getElementById('errorDiv').style.display = 'none';
            document.getElementById('resultSection').style.display = 'none';
            this.querySelector('button').disabled = true;

            // FormDataä½œæˆ
            const formData = new FormData();
            formData.append('file', file);

            try {
                console.log('Uploading to:', API_URL + '/scan');
                console.log('File:', file.name, file.size, 'bytes');

                const response = await fetch(API_URL + '/scan', {
                    method: 'POST',
                    body: formData,
                    mode: 'cors',
                });

                console.log('Response status:', response.status);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }

                const data = await response.json();
                console.log('Result:', data);

                displayResult(data);

            } catch (error) {
                console.error('Error:', error);
                showError(error.message);
            } finally {
                document.getElementById('loadingDiv').style.display = 'none';
                this.querySelector('button').disabled = false;
            }
        });

        function displayResult(data) {
            if (!data.success || !data.items) {
                showError('OCRå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ');
                return;
            }

            const resultDiv = document.getElementById('resultSection');
            
            let html = `
                <section class="result-section">
                    <h2>ğŸ“Š æŠ½å‡ºçµæœ</h2>
                    
                    <div class="formatted-output">
                        <strong>æŠ½å‡ºãƒ‡ãƒ¼ã‚¿:</strong>
                        <p class="result-text">${escapeHtml(data.formatted)}</p>
                    </div>

                    <div class="items-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>å•†å“å</th>
                                    <th>ä¾¡æ ¼</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            data.items.forEach(item => {
                html += `
                    <tr>
                        <td>${escapeHtml(item.name)}</td>
                        <td class="price">Â¥${item.price.toLocaleString()}</td>
                    </tr>
                `;
            });

            if (data.total) {
                html += `
                    <tr class="total-row">
                        <td><strong>åˆè¨ˆ</strong></td>
                        <td class="price"><strong>Â¥${data.total.toLocaleString()}</strong></td>
                    </tr>
                `;
            }

            html += `
                            </tbody>
                        </table>
                    </div>

                    <div class="download-buttons">
                        <button onclick="downloadCSV()" class="btn btn-success">
                            ğŸ“¥ CSV ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                        </button>
                    </div>

                    <details class="raw-text-section">
                        <summary>ğŸ” OCRç”Ÿãƒ†ã‚­ã‚¹ãƒˆã‚’è¡¨ç¤º</summary>
                        <pre>${escapeHtml(data.raw_text)}</pre>
                    </details>
                </section>
            `;

            resultDiv.innerHTML = html;
            resultDiv.style.display = 'block';

            // CSVç”¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            window.currentResult = data;
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorDiv');
            errorDiv.innerHTML = `
                <div class="alert alert-error">
                    âŒ ${escapeHtml(message)}
                </div>
            `;
            errorDiv.style.display = 'block';
        }

        function downloadCSV() {
            if (!window.currentResult) return;

            let csv = '\ufeff'; // BOM for Excel
            csv += 'å•†å“å,ä¾¡æ ¼\n';

            window.currentResult.items.forEach(item => {
                csv += `"${item.name}",${item.price}\n`;
            });

            if (window.currentResult.total) {
                csv += `"åˆè¨ˆ",${window.currentResult.total}\n`;
            }

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'result.csv';
            link.click();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
